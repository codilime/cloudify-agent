tosca_definitions_version: cloudify_dsl_1_1

imports:
  - http://www.getcloudify.org/spec/cloudify/3.3m5/types.yaml

inputs:
  package_url:
    description: Url of agent package to install
  agent_name:
    description: Name of installed agent

node_templates:

  agent_deleter:
    type: cloudify.nodes.Root
    interfaces:
      cloudify.interfaces.lifecycle:
        stop:
          implementation: agent.cloudify_agent.operations.delete_old_agents_amqp

  host:
    type: cloudify.nodes.Compute
    interfaces:
      cloudify.interfaces.cloudify_agent:
        create:
          inputs:
            cloudify_agent:
              name: { get_input: agent_name }
              queue: { get_input: agent_name }
              ip: 127.0.0.1
              manager_ip: 127.0.0.1
              local: true
              package_url: { get_input:  package_url  }
        stop: scripts/empty.py
        delete: scripts/empty.py
    relationships:
    - target: agent_deleter
      type: cloudify.relationships.depends_on
      source_interfaces:
        cloudify.interfaces.relationship_lifecycle:
          establish: scripts/inject_agent_data.py
